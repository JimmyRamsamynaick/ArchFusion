version: '3.8'

services:
  archfusion-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: archfusion-test-env
    hostname: archfusion-test
    
    # Variables d'environnement
    environment:
      - LANG=en_US.UTF-8
      - LC_ALL=en_US.UTF-8
      - TERM=xterm-256color
      - ARCHFUSION_TEST_MODE=true
      - ARCHFUSION_VERSION=2.0
    
    # Volumes pour persister les données et partager le code
    volumes:
      - ../:/workspace/archfusion:ro  # Code source en lecture seule
      - test-reports:/workspace/reports  # Rapports de test persistants
      - archfusion-cache:/tmp/archfusion-build  # Cache de build
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Pour les tests Docker (si nécessaire)
    
    # Configuration réseau
    networks:
      - archfusion-test-network
    
    # Ports exposés (pour les tests web si nécessaire)
    ports:
      - "8080:8080"
      - "3000:3000"
    
    # Commande par défaut
    command: >
      bash -c "
        echo '🚀 Démarrage de l'\''environnement de test ArchFusion' &&
        init-test-env.sh &&
        echo '📋 Lancement des tests automatiques...' &&
        cd /workspace/archfusion &&
        if [ -f tests/test-config.sh ]; then
          echo '🧪 Exécution des tests de configuration...' &&
          tests/test-config.sh
        else
          echo '⚠️  Script de test non trouvé'
        fi &&
        echo '✅ Tests terminés. Container prêt pour interaction.' &&
        exec tail -f /dev/null
      "
    
    # Configuration des ressources
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    
    # Politique de redémarrage
    restart: unless-stopped
    
    # Configuration de santé
    healthcheck:
      test: ["CMD", "check-prerequisites.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Labels pour l'organisation
    labels:
      - "project=archfusion"
      - "environment=test"
      - "version=2.0"

  # Service optionnel pour les tests de performance
  archfusion-perf-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: archfusion-perf-test
    hostname: archfusion-perf
    
    environment:
      - LANG=en_US.UTF-8
      - ARCHFUSION_TEST_MODE=performance
      - ARCHFUSION_VERSION=2.0
    
    volumes:
      - ../:/workspace/archfusion:ro
      - perf-reports:/workspace/reports
    
    networks:
      - archfusion-test-network
    
    command: >
      bash -c "
        echo '⚡ Environnement de test de performance ArchFusion' &&
        init-test-env.sh &&
        echo '📊 Prêt pour les tests de performance...' &&
        exec tail -f /dev/null
      "
    
    profiles:
      - performance  # Démarré uniquement avec --profile performance
    
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G

# Configuration des réseaux
networks:
  archfusion-test-network:
    driver: bridge
    name: archfusion-test-net
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volumes persistants
volumes:
  test-reports:
    name: archfusion-test-reports
    driver: local
  
  perf-reports:
    name: archfusion-perf-reports
    driver: local
  
  archfusion-cache:
    name: archfusion-build-cache
    driver: local
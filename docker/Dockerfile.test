# Dockerfile pour tester ArchFusion OS sans installation
FROM archlinux:latest

# MÃ©tadonnÃ©es
LABEL maintainer="ArchFusion Team"
LABEL description="Environnement de test pour ArchFusion OS"
LABEL version="1.0"

# Variables d'environnement
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV TERM=xterm-256color

# Mise Ã  jour du systÃ¨me et installation des outils de base
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
        base-devel \
        git \
        archiso \
        bash \
        zsh \
        curl \
        wget \
        nano \
        vim \
        tree \
        htop \
        neofetch \
        file \
        which \
        grep \
        sed \
        awk \
        tar \
        gzip \
        unzip \
        python \
        python-pip \
        jq \
        yamllint \
        shellcheck \
    && pacman -Scc --noconfirm

# Installation des outils de validation
RUN pip install --no-cache-dir \
        pyyaml \
        jsonschema \
        configparser

# CrÃ©ation de l'utilisateur de test
RUN useradd -m -G wheel -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# CrÃ©ation des rÃ©pertoires de travail
RUN mkdir -p /workspace/archfusion \
             /workspace/tests \
             /workspace/reports \
             /tmp/archfusion-build

# Configuration de l'environnement de test
WORKDIR /workspace/archfusion

# Script d'initialisation
RUN echo '#!/bin/bash' > /usr/local/bin/init-test-env.sh && \
    echo 'echo "ðŸš€ Initialisation de l'\''environnement de test ArchFusion"' >> /usr/local/bin/init-test-env.sh && \
    echo 'echo "ðŸ“ RÃ©pertoire de travail: $(pwd)"' >> /usr/local/bin/init-test-env.sh && \
    echo 'echo "ðŸ‘¤ Utilisateur: $(whoami)"' >> /usr/local/bin/init-test-env.sh && \
    echo 'echo "ðŸ§ SystÃ¨me: $(uname -a)"' >> /usr/local/bin/init-test-env.sh && \
    echo 'echo "ðŸ“¦ Archiso version: $(pacman -Q archiso 2>/dev/null || echo \"Non installÃ©\")"' >> /usr/local/bin/init-test-env.sh && \
    echo 'echo "âœ… Environnement prÃªt pour les tests"' >> /usr/local/bin/init-test-env.sh && \
    chmod +x /usr/local/bin/init-test-env.sh

# Script de validation des prÃ©requis
RUN echo '#!/bin/bash' > /usr/local/bin/check-prerequisites.sh && \
    echo 'echo "ðŸ” VÃ©rification des prÃ©requis..."' >> /usr/local/bin/check-prerequisites.sh && \
    echo 'commands=("mkarchiso" "pacman" "git" "bash" "zsh")' >> /usr/local/bin/check-prerequisites.sh && \
    echo 'for cmd in "${commands[@]}"; do' >> /usr/local/bin/check-prerequisites.sh && \
    echo '    if command -v "$cmd" >/dev/null 2>&1; then' >> /usr/local/bin/check-prerequisites.sh && \
    echo '        echo "âœ… $cmd: Disponible"' >> /usr/local/bin/check-prerequisites.sh && \
    echo '    else' >> /usr/local/bin/check-prerequisites.sh && \
    echo '        echo "âŒ $cmd: Manquant"' >> /usr/local/bin/check-prerequisites.sh && \
    echo '    fi' >> /usr/local/bin/check-prerequisites.sh && \
    echo 'done' >> /usr/local/bin/check-prerequisites.sh && \
    chmod +x /usr/local/bin/check-prerequisites.sh

# Configuration des permissions
RUN chown -R testuser:testuser /workspace && \
    chmod -R 755 /workspace

# Changement vers l'utilisateur de test
USER testuser

# Configuration du shell par dÃ©faut
RUN echo 'export PS1="[ArchFusion-Test] \u@\h:\w\$ "' >> ~/.bashrc && \
    echo 'alias ll="ls -la"' >> ~/.bashrc && \
    echo 'alias la="ls -A"' >> ~/.bashrc && \
    echo 'alias l="ls -CF"' >> ~/.bashrc && \
    echo 'alias test-config="/workspace/archfusion/tests/test-config.sh"' >> ~/.bashrc && \
    echo 'alias check-prereq="check-prerequisites.sh"' >> ~/.bashrc && \
    echo 'alias init-env="init-test-env.sh"' >> ~/.bashrc

# Point d'entrÃ©e par dÃ©faut
CMD ["/bin/bash", "-c", "init-test-env.sh && exec /bin/bash"]

# Exposition du port pour les tests web (si nÃ©cessaire)
EXPOSE 8080

# Volumes pour les donnÃ©es persistantes
VOLUME ["/workspace/archfusion", "/workspace/reports"]

# Sanity check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD check-prerequisites.sh > /dev/null 2>&1 || exit 1